<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>linux之网络 | mqray's blog</title><meta name="author" content="mqray"><meta name="copyright" content="mqray"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="网络模型OSI七层网络模型     四层网络     linux网络    linux网络收发流程    网络包的接收流程网络包的发送流程多路复用水平触发与边缘触发水平触发(level-trggered)：边缘触发(edge-triggered): 网络性能指标 带宽： 链路的最大传输速率，单位为b&#x2F;s。带宽和物理网卡的配置直接关联，实际带宽取决于整个网络链路中最小的一个。 时延: 网络">
<meta property="og:type" content="article">
<meta property="og:title" content="linux之网络">
<meta property="og:url" content="https://mqrayblog.cn/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/index.html">
<meta property="og:site_name" content="mqray&#39;s blog">
<meta property="og:description" content="网络模型OSI七层网络模型     四层网络     linux网络    linux网络收发流程    网络包的接收流程网络包的发送流程多路复用水平触发与边缘触发水平触发(level-trggered)：边缘触发(edge-triggered): 网络性能指标 带宽： 链路的最大传输速率，单位为b&#x2F;s。带宽和物理网卡的配置直接关联，实际带宽取决于整个网络链路中最小的一个。 时延: 网络">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mqrayblog.cn/img/avatar.png">
<meta property="article:published_time" content="2023-09-05T14:29:07.000Z">
<meta property="article:modified_time" content="2023-09-25T00:48:40.241Z">
<meta property="article:author" content="mqray">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mqrayblog.cn/img/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mqrayblog.cn/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: mqray","link":"链接: ","source":"来源: mqray's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'linux之网络',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-25 08:48:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="mqray's blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 编程</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/java/"><span> java</span></a></li><li><a class="site-page child" href="/tags/go/"><span> go</span></a></li><li><a class="site-page child" href="/tags/python/"><span> python</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/databases"><span> 数据库</span></a></div><div class="menus_item"><a class="site-page" href="/categories/middleware"><span> 中间件</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw native cloud"></i><span> 云原生</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/docker/"><span> docker</span></a></li><li><a class="site-page child" href="/tags/k8s/"><span> k8s</span></a></li><li><a class="site-page child" href="/tags/linux/"><span> linux</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw source"></i><span> 源码阅读</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/redis/"><span> redis</span></a></li><li><a class="site-page child" href="/tags/kafka/"><span> kafka</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw more"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/sth"><span> 随笔</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="mqray's blog"><span class="site-name">mqray's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> 编程</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/java/"><span> java</span></a></li><li><a class="site-page child" href="/tags/go/"><span> go</span></a></li><li><a class="site-page child" href="/tags/python/"><span> python</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/databases"><span> 数据库</span></a></div><div class="menus_item"><a class="site-page" href="/categories/middleware"><span> 中间件</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw native cloud"></i><span> 云原生</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/docker/"><span> docker</span></a></li><li><a class="site-page child" href="/tags/k8s/"><span> k8s</span></a></li><li><a class="site-page child" href="/tags/linux/"><span> linux</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw source"></i><span> 源码阅读</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/redis/"><span> redis</span></a></li><li><a class="site-page child" href="/tags/kafka/"><span> kafka</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw more"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/sth"><span> 随笔</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">linux之网络</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-05T14:29:07.000Z" title="发表于 2023-09-05 22:29:07">2023-09-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-25T00:48:40.241Z" title="更新于 2023-09-25 08:48:40">2023-09-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="linux之网络"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h3 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h3><h4 id="OSI七层网络模型"><a href="#OSI七层网络模型" class="headerlink" title="OSI七层网络模型"></a>OSI七层网络模型</h4><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_network_arch.png">  


<h4 id="四层网络"><a href="#四层网络" class="headerlink" title="四层网络"></a>四层网络</h4><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_network_4.png">  


<h4 id="linux网络"><a href="#linux网络" class="headerlink" title="linux网络"></a>linux网络</h4><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_network_kernel.webp">  

<h5 id="linux网络收发流程"><a href="#linux网络收发流程" class="headerlink" title="linux网络收发流程"></a>linux网络收发流程</h5><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_network_send_receive.webp">  

<h5 id="网络包的接收流程"><a href="#网络包的接收流程" class="headerlink" title="网络包的接收流程"></a>网络包的接收流程</h5><h5 id="网络包的发送流程"><a href="#网络包的发送流程" class="headerlink" title="网络包的发送流程"></a>网络包的发送流程</h5><h3 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h3><h4 id="水平触发与边缘触发"><a href="#水平触发与边缘触发" class="headerlink" title="水平触发与边缘触发"></a>水平触发与边缘触发</h4><p>水平触发(level-trggered)：<br>边缘触发(edge-triggered):</p>
<h3 id="网络性能指标"><a href="#网络性能指标" class="headerlink" title="网络性能指标"></a>网络性能指标</h3><ol>
<li>带宽： 链路的最大传输速率，单位为b&#x2F;s。带宽和物理网卡的配置直接关联，实际带宽取决于整个网络链路中最小的一个。</li>
<li>时延: 网络请求发出后，一直到收到远端响应所需要的事件延迟。在不同场景下含义有所不同，比如连接建立的时间(TCP握手延时)或者一个数据包往返所需时间(rtt)</li>
<li>吞吐量：标识没有丢包时的最大数据传输速率，单位为b&#x2F;s。吞吐量受带宽限制。</li>
<li>PPS： 即packet per second的缩写，标识以网络包为单位的传输速率，通常用来评估网络的转发能力。在以linux服务器转发时，很容易受到网络包大小的影响。</li>
</ol>
<h4 id="网络性能测试"><a href="#网络性能测试" class="headerlink" title="网络性能测试"></a>网络性能测试</h4><p>linux网络基于TCP&#x2F;IP协议栈，而不同协议层的行为不同。在评估网络性能前，需要确定应用程序基于协议栈的哪一层：</p>
<ol>
<li>基于http或者https的web应用程序，属于应用层，需要测试http&#x2F;https的性能。</li>
<li>对于游戏服务器，为了支持更多在线人数，通常基于tcp&#x2F;udp与客户端交互，此时需要测试tcp&#x2F;udp的性能。</li>
<li>将linux作为软交换机或者路由器来使用，此时则更关注网络包的处理能力，特别是网络层的转发性能。</li>
</ol>
<blockquote>
<p>底层协议是其上各层网络协议的基础，底层的性能决定了高层的网络性能。</p>
</blockquote>
<h5 id="测试网络接口层和网络层的性能"><a href="#测试网络接口层和网络层的性能" class="headerlink" title="测试网络接口层和网络层的性能"></a>测试网络接口层和网络层的性能</h5><p>网络接口层和网络层主要负责网络包的封装、寻址、路由、发送以及接收。这两层中每秒可处理的网络包PPS即是最重要的性能指标，特别是64B小包的处理能力。</p>
<p>Linux 内核自带的高性能网络测试工具 <code>pktgen</code></p>
<h5 id="tcp-udp性能测试"><a href="#tcp-udp性能测试" class="headerlink" title="tcp&#x2F;udp性能测试"></a>tcp&#x2F;udp性能测试</h5><p><code>iperf</code> 和 <code>netperf</code> 都是最常用的网络性能测试工具</p>
<h5 id="http性能测试"><a href="#http性能测试" class="headerlink" title="http性能测试"></a>http性能测试</h5><p>要测试 HTTP 的性能，也有大量的工具可以使用，比如 ab、webbench 等，都是常用的 HTTP 压力测试工具。其中，ab 是 Apache 自带的 HTTP 压测工具，主要测试 HTTP 服务的每秒请求数、请求延迟、吞吐量以及请求延迟的分布情况等。</p>
<p>为了得到应用程序的实际性能，就要求性能工具本身可以模拟用户的请求负载，而 iperf、ab 这类工具就无能为力了。幸运的是，我们还可以用 wrk、TCPCopy、Jmeter 或者 LoadRunner 等实现这个目标。</p>
<h3 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h3><h4 id="确定优化目标"><a href="#确定优化目标" class="headerlink" title="确定优化目标"></a>确定优化目标</h4><p>参考TCP&#x2F;IP分层协议簇，确定各层的性能预期。<br>除了上述描述的，针对传输层TCP&#x2F;UDP，网络包的大小会影响吞吐量(BPS)、连接数、延迟等指标。</p>
<h4 id="选用网络性能工具"><a href="#选用网络性能工具" class="headerlink" title="选用网络性能工具"></a>选用网络性能工具</h4><h5 id="根据指标选用工具"><a href="#根据指标选用工具" class="headerlink" title="根据指标选用工具"></a>根据指标选用工具</h5><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_net_opt_tool.png">  

<h5 id="根据工具查询指标"><a href="#根据工具查询指标" class="headerlink" title="根据工具查询指标"></a>根据工具查询指标</h5><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_net_tool_opt.webp">  

<h4 id="网络性能优化-1"><a href="#网络性能优化-1" class="headerlink" title="网络性能优化"></a>网络性能优化</h4><p>在获得网络基准测试报告后，通过相关性能工具，定位出网络性能瓶颈后，就可以进行优化了。<br>参考上述 LINUX系统下的网络协议栈和网络收发流程进行网络性能优化。<br>一般来说可以从： 应用程序，套接字、传输层、网络层和链路层等角度进行优化。</p>
<h5 id="应用程序优化"><a href="#应用程序优化" class="headerlink" title="应用程序优化"></a>应用程序优化</h5><p>应用程序通常是通过套接字接口进行网络操作。由于网络收发比较耗时，所以应用程序的优化，主要就是对网络IO和进程自身工作模型的优化。</p>
<ol>
<li>网络IO优化：<ul>
<li>使用epoll替代select和poll</li>
<li>使用异步io。 AIO允许应用程序同时发起很多IO操作，而不用等待操作完成，等到io完成后，系统会用<code>事件通知</code>的方式告知应用程序结果。不过AIO使用比较复杂，需要小心处理很多边缘情况。</li>
</ul>
</li>
<li>进程模型优化：<ul>
<li>主进程+ 多个worker子进程。 由主进程负责管理网络连接，子进程负责处理实际业务。</li>
<li>监听相同端口的多进程模型： 所有进程监听相同接口，并且开启<code>SO_REUSEPORT</code>选项，由内核负责，将请求负载均衡到这些监听进程中。</li>
</ul>
</li>
</ol>
<p>另外，应用层协议的优化也很重要，有如下常见的优化手段：</p>
<ol>
<li>使用长连接取代短连接，可以显著降低TCP建立连接的成本。在每秒请求次数较多时，效果明显。</li>
<li>使用内存等形式缓存不常变化的数据，可以降低网络IO次数，加快应用程序响应速度。</li>
<li>使用<code>protocol buffer</code>等序列化方式，压缩网络io的数据量，提高应用程序的吞吐。</li>
<li>使用<code>DNS预存、预取、HTTPDNS</code>等方式，减少DNS解析的延迟。</li>
</ol>
<h5 id="套接字优化"><a href="#套接字优化" class="headerlink" title="套接字优化"></a>套接字优化</h5><p>套接字可以屏蔽掉linux内核中不同协议的差异，为应用程序提供统一的访问接口。每个套接字都有一个读写缓冲区。</p>
<ul>
<li>读缓冲区： 缓存远端发来的数据，如果满就不能再接收新的数据。</li>
<li>写缓冲区：缓存要发出去的数据，如果满，应用程序的写操作就会被阻塞。<br>故而，为了提高网络吞吐量，通常需要调整这些缓冲区大小：</li>
</ul>
<ol>
<li>增大每个套接字的缓冲区大小： <code>net.core.optmem_max</code></li>
<li>增大套接字接收缓冲区大小： <code>net.core.rmem_max</code></li>
<li>增大套接字发送缓冲区大小： <code>net.core.wmem_max</code></li>
<li>增大TCP接收缓冲区大小:  <code>net.ipv4.tcp_rmem</code></li>
<li>增大TCP发送缓冲区大小:  <code>net.ipv4.tcp_wmem</code><br>除此之外，套接字的内核选项如下：</li>
</ol>
<img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_net_socket_prm.webp">  


<h5 id="传输层优化"><a href="#传输层优化" class="headerlink" title="传输层优化"></a>传输层优化</h5><p>实际上是指对两种协议的优化。</p>
<h6 id="TCP协议优化"><a href="#TCP协议优化" class="headerlink" title="TCP协议优化"></a>TCP协议优化</h6><p>流量控制：<br>慢启动：<br>拥塞控制：<br>延迟确认：<br>状态流图：如下图<br><img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_tcp_opt.webp">  </p>
<ol>
<li>请求数比较大的场景下，大量处于<code>TIME_WAIT</code>状态的连接，会占用大量内存和端口资源，此时可以优化与<code>TIME_WAIT</code>转台相关的内核选项：</li>
</ol>
<ul>
<li>增大处于<code>TIME_WAIT</code>状态的连接数量<code>net.ipv4.tcp_max_tw_buckets</code>,并增大连接跟踪表的大小<code>net.netfilter.nf_conntrack_max</code>。</li>
<li>减小<code>net.ipv4.tcp_fin_timeout</code>和 <code>net.netfilter.nf_conntrack_tcp_timeout_time_wait</code>，让系统尽快释放所占用的资源。</li>
<li>开启端口复用<code>net.ipv4.tcp_tw_reuse</code>，这样被<code>TIME_WAIT</code>状态占用的端口，还能用到新建的连接中。</li>
<li>增大本地端口范围<code>net.ipv4.ip_local_port_range</code>，这样可以支持更多的连接，提高整体的并发能力。</li>
<li>增大文件描述符的数量：使用<code>fs.nr_open</code>和<code>fs.file_max</code>分别增大进程和系统的最大文件描述符；或者在应用程序的<code>systemd</code>配置文件中，配置<code>limitnofile</code>设置应用程序的最大文件描述符。</li>
</ul>
<ol start="2">
<li>缓解<code>syn flood</code>利用<code>tcp</code>协议特点进行攻击而引发的性能问题，可以考虑优化与<code>syn</code>状态相关的内核选项：</li>
</ol>
<ul>
<li><p>增大<code>tcp</code>半连接的最大数量 <code>net.ipv4.tcp_max_syn_backlog</code>，或者开启<code>TCP SYN Cookies net.ipv4.tcp_syncookies</code>，来绕开半连接数量限制问题。[连着不可同时使用]</p>
</li>
<li><p>减少<code>SYN_RECV</code>状态连接重传<code>SYN+ACK</code>包的次数<code>net.ipv4.tcp_synack_retries</code>.</p>
</li>
</ul>
<ol start="3">
<li>在长连接的场景中，通常使用<code>keepalive</code>检测tcp连接的状态，以便对端连接断开后可以自动回收。但是<code>keepalive</code>探测间隔和重试次数一般都无法满足应用程序的性能，此时需要优化与<code>keepalive</code>相关的内核选项：</li>
</ol>
<ul>
<li>缩短最后一次数据包到<code>keepalive</code>探测包之间的间隔时间<code>net.ipv4.tcp_keepalive_time</code>;</li>
<li>缩短发送<code>keepalive</code>探测包的间隔时间<code>net.ipv4.tcp_keepalive_intvl</code></li>
<li>减少<code>keepalive</code>探测失败后，一直到通知应用程序前的重试次数<code>net.ipv4.tcp_keepalive_probes</code>.</li>
</ul>
<img src="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/linux_tcp_opt_core.webp"> 

<p>另外，如果使用不同的优化方法，可能会产生冲突。比如服务端使用<code>nagle</code>算法，客户端开启延时确认，就很容易导致网络延时增大。<br>对于<code>NAT</code>服务器而言，如果开启<code>net.ipv4.tcp_tw_recycle</code>就很容易导致各种连接失败，已于内核的4.1版本中删除。</p>
<h6 id="UDP协议优化"><a href="#UDP协议优化" class="headerlink" title="UDP协议优化"></a>UDP协议优化</h6><ol>
<li>增大套接字缓冲区大小和<code>UDP</code>缓冲区范围；</li>
<li>增大本地端口号范围；</li>
<li>根据<code>MTU</code>大小，调整<code>UDP</code>数据包的大小，减少或者避免分片。</li>
</ol>
<h5 id="网络层优化"><a href="#网络层优化" class="headerlink" title="网络层优化"></a>网络层优化</h5><p>网络层负责网络包的封装、寻址和路由，包括IP、ICMP协议。在网络层最主要的优化是对路由、<code>IP</code>分片以及<code>ICMP</code>等进行调优。</p>
<ol>
<li>从路由和转发的角度，可以调整如下内核选项：</li>
</ol>
<ul>
<li>在需要转发的服务器中，比如用作<code>nat网关</code>的服务器或者使用docker容器时，设置<code>net.ipv4.ip_forward=1</code>开启<code>IP转发</code>。</li>
<li>调整数据包的生存周期<code>TTL</code>，比如设置<code>net.ipv4.ip-default_ttl=64</code>.[增大该值会降低系统性能]</li>
<li>设置<code>net.ipv4.conf.eth0.rp_filter=1</code>开启数据包的反向地址校验，防止IP欺骗减少伪造IP带来的<code>DDOS</code>问题。</li>
</ul>
<ol start="2">
<li>从分片的角度，调整<code>MTU</code>大小<br>以太网标准规定，一个网络帧最大为 1518B，那么去掉以太网头部的 18B 后，剩余的 1500 就是以太网 MTU 的大小。在使用<code>VXLAN、GRE</code>等叠加网络技术后，会使原来的网络包变大，使得MTU也需要调整。<br>以VXLAN为例，它在原来报文的基础上，增加了 14B 的以太网头部、 8B 的 VXLAN 头部、8B 的 UDP 头部以及 20B 的 IP 头部。换句话说，每个包比原来增大了 50B。<br>所以就需要交换机、路由器等的<code>MTU</code>增大到1550，或者把<code>VXLAN</code>封包前的<code>MTU</code>减小为1450。<br>当然，考虑到许多网络设备都支持<code>巨帧</code>，这种情况下，可以将<code>MTU</code>调大为9000，以提高网络吞吐量。</li>
<li>以ICMP角度出发，为了避免ICMP主机探测、ICMP flood等各种网络问题，可以通过内核选项，限制ICMP行为。</li>
</ol>
<ul>
<li>设置<code>net.ipv4.icmp_echo_ignore_all=1</code>禁用<code>ICMP</code>协议，外部主机就无法通过<code>ping</code>等使用<code>ICMP</code>协议的命令来探测主机。</li>
<li>设置<code>net.ipv4.icmp_echo_ignore_broadcasts=1</code>禁止广播<code>ICMP</code>.</li>
</ul>
<h5 id="链路层优化"><a href="#链路层优化" class="headerlink" title="链路层优化"></a>链路层优化</h5><p>链路层负责网络包在物理网络中的传输：<code>MAC寻址</code>、错误探测、通过网卡传输网络帧。</p>
<ol>
<li>由于网卡收包之后调用的中断处理程序(特别是软中断)，需要消耗大量的CPU，所以将这些中断处理程序调度到不同的CPU上执行，就可以显著提高网络吞吐量。</li>
</ol>
<ul>
<li>为网卡硬中断配置CPU亲和性(smp_affinity)，或者开启<code>irqbalance</code>。</li>
<li>开启<code>RPS (receive packet steering)</code> 和<code>RFS (receive flow steering)</code>将应用程序和软中断的处理，调度到相同的CPU上。这样就可以增加CPU命中率，减少网络延时。</li>
</ul>
<ol start="2">
<li>原来内核中通过软件处理的功能可以卸载到网卡中，通过硬件执行：</li>
</ol>
<ul>
<li><code>TSO(TCP Segmentation Offload) | UFO (UDP Fragmentation Offload)</code>: 在<code>TCP/UDP</code>协议中直接发送大包，<code>TCP|UDP</code>包的分段|分片功能交由网卡完成。</li>
<li>GSO (Generic Segmentation Offload): 网卡不支持TSO|ufo时，将分片和分段操作延迟到进入网卡前再执行。</li>
<li>LRO（Large Receive Offload）：在接收 TCP 分段包时，由网卡将其组装合并后，再交给上层网络处理。不过要注意，在需要 IP 转发的情况下，不能开启 LRO，因为如果多个包的头部信息不一致，LRO 合并会导致网络包的校验错误。</li>
<li>GRO（Generic Receive Offload）：GRO 修复了 LRO 的缺陷，并且更为通用，同时支持 TCP 和 UDP。</li>
<li>RSS（Receive Side Scaling）：也称为多队列接收，它基于硬件的多个接收队列，来分配网络接收进程，这样可以让多个 CPU 来处理接收到的网络包。</li>
<li>VXLAN 卸载：也就是让网卡来完成 VXLAN 的组包功能。</li>
</ul>
<ol start="3">
<li>网络接口本身</li>
</ol>
<ul>
<li>开启网络接口的多队列功能，每个队列可以用不同的中断号，调度到不同的CPU上执行。</li>
<li>增大网络接口的缓冲区和队列长度</li>
<li>使用<code>traffic control</code>工具，为不同的网络流量配置<code>QOS</code></li>
</ul>
<p>另外，在单机<code>10M</code>场景下，网络协议栈的冗长流程才是最主要的性能负担。这种场景下，可以使用两种方式进行优化。</p>
<ul>
<li>使用<code>DPDK</code>技术，跳过内核协议栈，直接由用户态进程用轮询的方式，处理网络请求。同时结合大页、cpu绑定、内存对齐、流水线并发等多种机制，优化网络包处理效率。</li>
<li>使用内核自带的<code>XDP</code>技术，在网络包进入内核协议前就对齐进行处理。<blockquote>
<p>nslookup ip<br>time nslookup ip<br>ping -c3 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a><br>dnsmasq &#x2F;etc&#x2F;init.d&#x2F;dnsmasq start<br>dig +trace +nodnssec time.geekbang.org<br>strace</p>
</blockquote>
</li>
</ul>
<p>域名劫持和规避<br>客户端：HTTPDNS</p>
<p>全局负载均衡（GSLB）</p>
<p>PTR 请求</p>
<p>tcpdump</p>
<p>iptable</p>
<p>traceroute<br>tracepath<br>nc</p>
<p>&#x2F;proc&#x2F;sys&#x2F;fs&#x2F;file-max</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/81268">1. 极客时间-linux性能优化</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/lihao21/article/details/67631516">2. 水平触发和边缘触发</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yolo_yyh/article/details/118367979">3. 陈硕-muduo网络库与服务模型介绍</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1721171">4. linux版本查看</a><br><a target="_blank" rel="noopener" href="https://plantegg.github.io/2019/01/09/nslookup-OK-but-ping-fail/">5. dns排障实例</a><br><a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc-index.html">6. rfc</a><br><a target="_blank" rel="noopener" href="https://wiki.wireshark.org/TCP%204-times%20close">7. wireshark四次挥手案例</a><br><a href>8. 林沛满《Wireshark网络分析就这么简单》和《Wireshark网络分析的艺术》</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mqray">mqray</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mqrayblog.cn/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/">https://mqrayblog.cn/2023/09/05/linux之网络/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mqrayblog.cn" target="_blank">mqray's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/linux/">linux</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/19/linux%E4%B9%8Biptable/" title="linux之iptable"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">linux之iptable</div></div></a></div><div class="next-post pull-right"><a href="/2023/09/05/redis%E4%B9%8B%E4%BA%8B%E5%8A%A1/" title="redis之事务"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">redis之事务</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/09/19/linux%E4%B9%8Biptable/" title="linux之iptable"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-19</div><div class="title">linux之iptable</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mqray</div><div class="author-info__description">明日复明日，明日何其多？</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mqray"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text">网络模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OSI%E4%B8%83%E5%B1%82%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">OSI七层网络模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E7%BD%91%E7%BB%9C"><span class="toc-number">1.2.</span> <span class="toc-text">四层网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux%E7%BD%91%E7%BB%9C"><span class="toc-number">1.3.</span> <span class="toc-text">linux网络</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#linux%E7%BD%91%E7%BB%9C%E6%94%B6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">linux网络收发流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8C%85%E7%9A%84%E6%8E%A5%E6%94%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">网络包的接收流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8C%85%E7%9A%84%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">网络包的发送流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">多路复用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91%E4%B8%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91"><span class="toc-number">2.1.</span> <span class="toc-text">水平触发与边缘触发</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">3.</span> <span class="toc-text">网络性能指标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.</span> <span class="toc-text">网络性能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%B1%82%E5%92%8C%E7%BD%91%E7%BB%9C%E5%B1%82%E7%9A%84%E6%80%A7%E8%83%BD"><span class="toc-number">3.1.1.</span> <span class="toc-text">测试网络接口层和网络层的性能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tcp-udp%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">tcp&#x2F;udp性能测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.3.</span> <span class="toc-text">http性能测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">网络性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E4%BC%98%E5%8C%96%E7%9B%AE%E6%A0%87"><span class="toc-number">4.1.</span> <span class="toc-text">确定优化目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E7%94%A8%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E5%B7%A5%E5%85%B7"><span class="toc-number">4.2.</span> <span class="toc-text">选用网络性能工具</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%8C%87%E6%A0%87%E9%80%89%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">4.2.1.</span> <span class="toc-text">根据指标选用工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%B7%A5%E5%85%B7%E6%9F%A5%E8%AF%A2%E6%8C%87%E6%A0%87"><span class="toc-number">4.2.2.</span> <span class="toc-text">根据工具查询指标</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-1"><span class="toc-number">4.3.</span> <span class="toc-text">网络性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.1.</span> <span class="toc-text">应用程序优化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.2.</span> <span class="toc-text">套接字优化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.3.</span> <span class="toc-text">传输层优化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#TCP%E5%8D%8F%E8%AE%AE%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">TCP协议优化</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#UDP%E5%8D%8F%E8%AE%AE%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.3.2.</span> <span class="toc-text">UDP协议优化</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.4.</span> <span class="toc-text">网络层优化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E5%B1%82%E4%BC%98%E5%8C%96"><span class="toc-number">4.3.5.</span> <span class="toc-text">链路层优化</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number"></span> <span class="toc-text">引用</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/22/%E5%B7%A5%E4%BD%9C%E4%B9%8B%E5%B7%A5%E7%A8%8B%E6%9C%AF%E8%AF%AD/" title="工作之工程术语">工作之工程术语</a><time datetime="2023-09-22T02:23:32.000Z" title="发表于 2023-09-22 10:23:32">2023-09-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/21/java%E4%B9%8Bjprofile%E5%88%86%E6%9E%90%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8/" title="java之jprofile分析内存占用">java之jprofile分析内存占用</a><time datetime="2023-09-21T07:53:18.000Z" title="发表于 2023-09-21 15:53:18">2023-09-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/20/redis%E4%B9%8B%E6%8E%92%E9%9A%9C/" title="redis之排障">redis之排障</a><time datetime="2023-09-20T13:28:31.000Z" title="发表于 2023-09-20 21:28:31">2023-09-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/19/linux%E4%B9%8Biptable/" title="linux之iptable">linux之iptable</a><time datetime="2023-09-19T14:39:54.000Z" title="发表于 2023-09-19 22:39:54">2023-09-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/05/linux%E4%B9%8B%E7%BD%91%E7%BB%9C/" title="linux之网络">linux之网络</a><time datetime="2023-09-05T14:29:07.000Z" title="发表于 2023-09-05 22:29:07">2023-09-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2023 By mqray</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">mqray's website</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '8ecec252629429565e5d',
      clientSecret: 'c0e21bd6dccb5470afcdcf519eb3aea73988a427',
      repo: 'mqray.github.io',
      owner: 'mqray',
      admin: ['mqray'],
      id: '77f12058bb35744ea7ffa8836917656f',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>