<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>redis之特殊数据类型 | mqray&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="bitmapbitmap即位图，是一种基于位运算的数据结构，用连续的二进制位描述某些业务，例如用户的签到状态等。redis中的string是二进制安全的，故而使用string来描述这个位图。相比其他数据结构，位图所占用的存储空间非常小，在上述的业务场景，使用位图更加高效。 Redis提供了SETBIT、GETBIT 、BITCOUNT 、BITOP四个命令，用于处理二进制数组 SETBIT1SET">
<meta property="og:type" content="article">
<meta property="og:title" content="redis之特殊数据类型">
<meta property="og:url" content="https://mqrayblog.cn/2023/07/21/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/index.html">
<meta property="og:site_name" content="mqray&#39;s blog">
<meta property="og:description" content="bitmapbitmap即位图，是一种基于位运算的数据结构，用连续的二进制位描述某些业务，例如用户的签到状态等。redis中的string是二进制安全的，故而使用string来描述这个位图。相比其他数据结构，位图所占用的存储空间非常小，在上述的业务场景，使用位图更加高效。 Redis提供了SETBIT、GETBIT 、BITCOUNT 、BITOP四个命令，用于处理二进制数组 SETBIT1SET">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mqrayblog.cn/2023/07/21/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/bit-map.png">
<meta property="article:published_time" content="2023-07-20T17:26:45.000Z">
<meta property="article:modified_time" content="2023-10-30T16:15:39.967Z">
<meta property="article:author" content="mqray">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mqrayblog.cn/2023/07/21/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/bit-map.png">
  
    <link rel="alternate" href="/atom.xml" title="mqray's blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">mqray&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://mqrayblog.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-redis之特殊数据类型" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/07/21/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="article-date">
  <time class="dt-published" datetime="2023-07-20T17:26:45.000Z" itemprop="datePublished">2023-07-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/databases/">databases</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      redis之特殊数据类型
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h3><p><code>bitmap</code>即位图，是一种基于位运算的数据结构，用连续的二进制位描述某些业务，例如用户的签到状态等。<code>redis</code>中的string是二进制安全的，故而使用string来描述这个位图。<br>相比其他数据结构，位图所占用的存储空间非常小，在上述的业务场景，使用位图更加高效。<br><img src="./redis之特殊数据类型/bit-map.png"></p>
<p>Redis提供了<code>SETBIT</code>、<code>GETBIT</code> 、<code>BITCOUNT</code> 、<code>BITOP</code>四个命令，用于处理二进制数组</p>
<h4 id="SETBIT"><a href="#SETBIT" class="headerlink" title="SETBIT"></a>SETBIT</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETBIT key offset value </span><br></pre></td></tr></table></figure>
<p><code>SETBIT</code>用于将二进制数组在偏移量位置处的二进制值设置为value，当<code>key</code>不存在时，会自动生成一个新的字符串值。字符串会扩展以确保可以在offset位置上设置value值，当字符串扩展时，空白位置以0填充 offset&gt;&#x3D;0， 小于512M<br>注意对于较大的<code>OFFSET</code>值，命令执行过程中的内存分配可能阻塞redis服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">123.122.10.231:6379&gt; setbit bitmap 10086 1</span><br><span class="line">(integer) 0</span><br><span class="line">123.122.10.231:6379&gt; getbit bitmap 10086</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>
<h5 id="setbit的执行过程"><a href="#setbit的执行过程" class="headerlink" title="setbit的执行过程"></a>setbit的执行过程</h5><ol>
<li>计算保存offset偏移量指定的二进制位至少需要多少个字节：<br> <code>len=[offset/8] + 1</code> 向下取整。</li>
<li>检查这个位图对应的<code>redisObject.ptr</code>指向的<code>sdshar</code>的len字段<br>是否小于步骤1中计算的len值，如果小于，则将sds的长度扩展为len字节，并将所有扩展空间的二进制位设置为0。</li>
<li>计算offset偏移量指定的二进制位保存在哪一个字节：<br><code>byte=offset/8</code>。</li>
<li>计算offset偏移量指定的二进制位在byte个字节中的第几个二进制位：<br><code>bit=offser%8 + 1</code>。</li>
<li>根据计算得出的byte和bit定位到二进制数组中offset的位置，将旧值存储在oldvalue中，并将其值修改为value指定的值。</li>
<li>最后，向客户端返回oldvalue的值。</li>
</ol>
<p>上述计算过程均可以在常数时间内完成，故而其时间复杂度为<code>O(1)</code></p>
<h4 id="GETBIT"><a href="#GETBIT" class="headerlink" title="GETBIT"></a>GETBIT</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GETBIT key offset </span><br></pre></td></tr></table></figure>
<p>获取二进制数组key指定偏移量offset处的值。当offset比字符串值的长度大或者key不存在时，返回0。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">123.122.10.231:6379&gt; getbit bitmap 10086</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<h5 id="getbit的执行过程"><a href="#getbit的执行过程" class="headerlink" title="getbit的执行过程"></a>getbit的执行过程</h5><p>和<code>setbit</code>类似，核心就是计算<code>byte</code>和<code>bit</code>。命令执行过程如下：</p>
<ol>
<li>计算byte</li>
<li>计算bit</li>
<li>根据byte 和 bit定位到二进制数组中偏移量位置，读取该位置上的值</li>
</ol>
<p>上述过程的时间复杂度也为<code>O(1)</code></p>
<h4 id="BITCOUNT"><a href="#BITCOUNT" class="headerlink" title="BITCOUNT"></a>BITCOUNT</h4><p>此命令经常被用于统计用户上线次数等业务：<a target="_blank" rel="noopener" href="http://redisdoc.com/bitmap/bitcount.html">模式：使用 bitmap 实现用户上线次数统计</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BITCOUNT key [start] [end]</span><br></pre></td></tr></table></figure>
<p>计算给定字符串key中，被设置为1的比特位数量；也可以只计算start到stop指定的字节范围的二进制数组。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">123.122.10.231:6379&gt; getbit bitmap 10086</span><br><span class="line">(integer) 1</span><br><span class="line">123.122.10.231:6379&gt; bitcount bitmap</span><br><span class="line">(integer) 1</span><br><span class="line">123.122.10.231:6379&gt; setbit bitmap 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">123.122.10.231:6379&gt; setbit bitmap 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">123.122.10.231:6379&gt; bitcount bitmap</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<h5 id="bitcount实现原理"><a href="#bitcount实现原理" class="headerlink" title="bitcount实现原理"></a>bitcount实现原理</h5><p>在数学上，统计一个二进制数组中，非0二进制位的数量，被称作<code>计算汉明重量</code>，该算法通过一系列位移和位运算操作，可以在常数时间内计算多个字节的汉明重量，并且不需要使用任何额外的内存。<br>参见<code>variable-precision swar</code>算法<br>redis使用查表法+swar实现：<br>redis中采用的实现源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Count number of bits set in the binary array pointed by &#x27;s&#x27; and long</span></span><br><span class="line"><span class="comment"> * &#x27;count&#x27; bytes. The implementation of this function is required to</span></span><br><span class="line"><span class="comment"> * work with an input string length up to 512 MB or more (server.proto_max_bulk_len) */</span></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> <span class="title function_">redisPopcount</span><span class="params">(<span class="type">void</span> *s, <span class="type">long</span> count)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> bits = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *p = s;</span><br><span class="line">    <span class="type">uint32_t</span> *p4;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> bitsinbyte[<span class="number">256</span>] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Count initial bytes not aligned to 32 bit. */</span></span><br><span class="line">    <span class="keyword">while</span>((<span class="type">unsigned</span> <span class="type">long</span>)p &amp; <span class="number">3</span> &amp;&amp; count) &#123;</span><br><span class="line">        bits += bitsinbyte[*p++];</span><br><span class="line">        count--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Count bits 28 bytes at a time */</span></span><br><span class="line">    p4 = (<span class="type">uint32_t</span>*)p;</span><br><span class="line">    <span class="keyword">while</span>(count&gt;=<span class="number">28</span>) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> aux1, aux2, aux3, aux4, aux5, aux6, aux7;</span><br><span class="line"></span><br><span class="line">        aux1 = *p4++;</span><br><span class="line">        aux2 = *p4++;</span><br><span class="line">        aux3 = *p4++;</span><br><span class="line">        aux4 = *p4++;</span><br><span class="line">        aux5 = *p4++;</span><br><span class="line">        aux6 = *p4++;</span><br><span class="line">        aux7 = *p4++;</span><br><span class="line">        count -= <span class="number">28</span>;</span><br><span class="line"></span><br><span class="line">        aux1 = aux1 - ((aux1 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux1 = (aux1 &amp; <span class="number">0x33333333</span>) + ((aux1 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux2 = aux2 - ((aux2 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux2 = (aux2 &amp; <span class="number">0x33333333</span>) + ((aux2 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux3 = aux3 - ((aux3 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux3 = (aux3 &amp; <span class="number">0x33333333</span>) + ((aux3 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux4 = aux4 - ((aux4 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux4 = (aux4 &amp; <span class="number">0x33333333</span>) + ((aux4 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux5 = aux5 - ((aux5 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux5 = (aux5 &amp; <span class="number">0x33333333</span>) + ((aux5 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux6 = aux6 - ((aux6 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux6 = (aux6 &amp; <span class="number">0x33333333</span>) + ((aux6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        aux7 = aux7 - ((aux7 &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">        aux7 = (aux7 &amp; <span class="number">0x33333333</span>) + ((aux7 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">        bits += ((((aux1 + (aux1 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux2 + (aux2 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux3 + (aux3 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux4 + (aux4 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux5 + (aux5 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux6 + (aux6 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>) +</span><br><span class="line">                    ((aux7 + (aux7 &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F</span>))* <span class="number">0x01010101</span>) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Count the remaining bytes. */</span></span><br><span class="line">    p = (<span class="type">unsigned</span> <span class="type">char</span>*)p4;</span><br><span class="line">    <span class="keyword">while</span>(count--) bits += bitsinbyte[*p++];</span><br><span class="line">    <span class="keyword">return</span> bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="BITOP"><a href="#BITOP" class="headerlink" title="BITOP"></a>BITOP</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BITOP operation destkey key [key …]</span><br></pre></td></tr></table></figure>
<p>对一个或多个二进制数组key进行元操作，并将结果保存到二进制数组destkey中。其中<code>operation</code>可以是<code>and</code>、<code>or</code>、<code>not</code>、<code>xor</code>中的任意一种，对应与或非、异或操作。</p>
<h3 id="hyperloglog"><a href="#hyperloglog" class="headerlink" title="hyperloglog"></a>hyperloglog</h3><p><code>hyperloglog</code>并非<code>redis</code>特有，它是一种基于统计的算法，用以计算大数据场景下统计基数的算法：<br>目前用于基数统计的算法包括：</p>
<ol>
<li>linear counting(LC): 早期的基数估算算法，时间复杂度是O(N)。</li>
<li>LogLog counting(LLC): 相比LC更节省内存，空间复杂度为O(log(log(N)))。</li>
<li>hyperloglog counting(HLLC): 是基于LLC的优化，在相同的空间复杂度下，比LLC的误差要小。</li>
</ol>
<p>其优点在于，在输入的元素数量或者所占空间非常大时，计算基数的空间开销非常少。每个<code>hyperloglog</code>键只需要花费12KB的内存，就可以计算<code>2^64</code>个不同元素的基数。<br>另外，它只会根据输入元素计算基数，不会存储元素本身，所以不能返回各个元素。</p>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 将任意数量的元素添加到指定的hyperloglog中</span><br><span class="line">PFADD key element [element …]</span><br><span class="line"></span><br><span class="line">// 返回在给定键的hyperloglog的近似基数，key不存在则返回0</span><br><span class="line">PFCOUNT key [key …]</span><br><span class="line"></span><br><span class="line">// 将多个hyperloglog 合并为 一个</span><br><span class="line">PFMERGE destkey sourcekey [sourcekey …]</span><br></pre></td></tr></table></figure>
<p><code>PFADD</code>命令的返回取决于执行命令后，<code>hyperloglog</code>估计的基数发生变化时，则返回1，否则返回0。命令不会一次性分配12K内存。[具体的扩展原则见源码]</p>
<p>如果该key值不存在，则先创建，再执行此命令。<br><code>PFCOUNT</code>返回的基数并不是精确值，而是带有一个<code>0.81%</code>标准错误的近似值。<br><code>PFMERGE</code>，将多个<code>hyperloglog</code>合并为一个，合并后的<code>htperloglog</code>的基数接近于所有输入的<code>hyperloglog</code>可见集合的并集。<br><code>hyperloglog</code>的源码实现主要参考 <code>P. Flajolet, Éric Fusy, O. Gandouet, and F. Meunier. Hyperloglog: The analysis of a near-optimal cardinality estimation algorithm</code></p>
<p>实际操作如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">123.122.10.231:6379&gt; PFADD  database  &quot;Redis&quot;  &quot;MongoDB&quot;  &quot;MySQL&quot;</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [246] located at 123.122.42.170:6379</span></span><br><span class="line">(integer) 1</span><br><span class="line">123.122.42.170:6379&gt; PFADD  database  &quot;PostgreSQL&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">123.122.42.170:6379&gt; PFCOUNT  database</span><br><span class="line">(integer) 4</span><br><span class="line">123.122.42.170:6379&gt; PFADD  database  &quot;PostgreSQL&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">123.122.42.170:6379&gt; PFCOUNT  database</span><br><span class="line">(integer) 4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">123.122.42.170:6379&gt;  PFADD  nosql  &quot;Redis&quot;  &quot;MongoDB&quot;  &quot;Memcached&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">123.122.42.170:6379&gt; PFADD  RDBMS  &quot;MySQL&quot; &quot;MSSQL&quot; &quot;PostgreSQL&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">123.122.42.170:6379&gt;  PFMERGE  databases  nosql  RDBMS</span><br><span class="line">OK</span><br><span class="line">123.122.42.170:6379&gt;  PFCOUNT  databases</span><br><span class="line">(integer) 6</span><br></pre></td></tr></table></figure>


<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ol>
<li>由于不需要保存数据内容+计算基数特别快，所以非常适合计算日活、月活数据</li>
</ol>
<h3 id="geo"><a href="#geo" class="headerlink" title="geo"></a>geo</h3><p>redis 3.2版本开始提供了<code>geo(地理信息定位)</code>功能，支持存储地理位置信息。</p>
<h4 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 将给定的空间元素加到指定的键中 [longitude latitude member]， 这些元素会以有序集合的形式被存储在键中</span><br><span class="line">GEOADD key longitude latitude member [longitude latitude member …]</span><br><span class="line"></span><br><span class="line">// 从key中获取 给定位置元素的位置，返回经纬度</span><br><span class="line">GEOPOS key member [member …]</span><br><span class="line"></span><br><span class="line">// 返回两个给定位置之间的距离 </span><br><span class="line">GEODIST key member1 member2 [unit]</span><br><span class="line"></span><br><span class="line">//  以给定的经纬度为中心，返回键中与中心点距离不超过最大距离的所有元素位置</span><br><span class="line">GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count]</span><br><span class="line"></span><br><span class="line">// 和GEORADIUS类似，不过是以键中元素作为圆心返回与之距离不超过最大距离的所有元素位置</span><br><span class="line">GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count]</span><br><span class="line"></span><br><span class="line">// 返回某元素位置的 geohash表示</span><br><span class="line">GEOHASH key member [member …]</span><br></pre></td></tr></table></figure>
<p><code>GEOADD</code>命令以标准(x,y)的形式接收输入参数，经度在前，纬度在后。另外，它能够记录的坐标是有限的，非常接近两级的区域无法被索引，精确的坐标限制为:</p>
<ol>
<li>有效的经度介于 -180 度至 180 度之间。</li>
<li>有效的纬度介于 -85.05112878 度至 85.05112878 度之间。<br>超出上述范围则会返回错误。</li>
</ol>
<p><code>GEODIST</code>命令中默认的单位为m，可选参数有：</p>
<ol>
<li>m，即米。</li>
<li>km，即千米。</li>
<li>mi， 即英里。</li>
<li>ft，即英尺。</li>
</ol>
<p><code>geohash</code>: 对于精度维度而言，<code>geohash</code>会将其编码为N位的二进制数，实际上就是通过N次分区实现。<br>对于某一位置元素，分别对其经度和维度进行编码，得到的两个二进制数，偶数位放置经度值，奇数为放置维度，最后使用base32进行编码即得到最后的输出。<br>这里要注意的是，geohash算法使用的是<code>peano空间填充曲线</code>，这种曲线会产生突变，会导致编码虽然相似，但其距离可能相差很大的问题。在实际应用中，需要先筛选相似<code>geohash</code>编码相似的点，然后计算实际距离。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">123.122.228.34:6379&gt; zrange citys 0 -1 withscores </span><br><span class="line"> 1) &quot;zhuhai&quot;</span><br><span class="line"> 2) &quot;4046325959374599&quot;</span><br><span class="line"> 3) &quot;guangzhou&quot;</span><br><span class="line"> 4) &quot;4046533892156333&quot;</span><br><span class="line"> 5) &quot;shenzhen&quot;</span><br><span class="line"> 6) &quot;4046615882282816&quot;</span><br><span class="line"> 7) &quot;shanghai&quot;</span><br><span class="line"> 8) &quot;4066919243534770&quot;</span><br><span class="line"> 9) &quot;beijing&quot;</span><br><span class="line">10) &quot;4069885649163649&quot;</span><br></pre></td></tr></table></figure>
<p><code>geo</code>中使用某种编码将经纬度设置为 对应 memeber 的 score。<br>故而，<code>GEOADD citys 116.41667 39.91667 &quot;beijing&quot;</code>命令等价于：<br><code>ZADD citys 4069885649163649 beijing</code>。</p>
<p>实际操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">123.122.10.231:6379&gt; GEOADD citys 116.41667 39.91667 &quot;beijing&quot; 121.43333 34.50000 &quot;shanghai&quot; 113.23333 23.16667 &quot;guangzhou&quot; 114.06667 22.61667 &quot;shenzhen&quot;   113.51667 22.30000 &quot;zhuhai&quot;</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [9558] located at 123.122.228.34:6379</span></span><br><span class="line">(integer) 5</span><br><span class="line">123.122.228.34:6379&gt; geopos citys beijing</span><br><span class="line">1) 1) &quot;116.41667157411575317&quot;</span><br><span class="line">   2) &quot;39.91667095273589183&quot;</span><br><span class="line">123.122.10.231:6379&gt; geodist citys beijing shanghai  km</span><br><span class="line">&quot;748.3469&quot;</span><br><span class="line">123.122.228.34:6379&gt; georadius citys 116 39 500 km</span><br><span class="line">1) &quot;beijing&quot;</span><br><span class="line">123.122.228.34:6379&gt; GEORADIUSBYMEMBER citys shanghai 1000 km</span><br><span class="line">1) &quot;shanghai&quot;</span><br><span class="line">2) &quot;beijing&quot;</span><br><span class="line">123.122.228.34:6379&gt; GEORADIUSBYMEMBER citys shanghai 2000  km</span><br><span class="line">1) &quot;zhuhai&quot;</span><br><span class="line">2) &quot;guangzhou&quot;</span><br><span class="line">3) &quot;shenzhen&quot;</span><br><span class="line">4) &quot;shanghai&quot;</span><br><span class="line">5) &quot;beijing&quot;</span><br><span class="line">123.122.228.34:6379&gt; GEOHASH citys shenzhen</span><br><span class="line">1) &quot;ws10ethzdh0&quot;</span><br><span class="line"></span><br><span class="line">123.122.228.34:6379&gt; type citys </span><br><span class="line">zset</span><br><span class="line">123.122.228.34:6379&gt; OBJECT encoding citys</span><br><span class="line">&quot;ziplist</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><p>适用于和位置相关的业务，例如附近的人、共享单车等。</p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35190492/article/details/123467702">1. 详解redis bitmap</a><br><a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/2495b90a647f9f9987202efd29647f81f217b8ad/src/hyperloglog.c">2. redis hyperloglog实现</a><br><a target="_blank" rel="noopener" href="http://redisdoc.com/geo/georadius.html">3. redis geo命令参考</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LBSer/p/3310455.html">4. GeoHash核心原理解析</a>  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mqrayblog.cn/2023/07/21/redis%E4%B9%8B%E7%89%B9%E6%AE%8A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" data-id="clod3qsxh0012kyor1p9fcwlc" data-title="redis之特殊数据类型" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/07/23/redis%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          redis之服务器
        
      </div>
    </a>
  
  
    <a href="/2023/07/19/redis%E5%9F%BA%E7%A1%80/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">redis之基础数据类型</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/coding/">coding</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/databases/">databases</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sth/" rel="tag">sth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E9%9A%9C/" rel="tag">排障</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="tag">源码阅读</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/java/" style="font-size: 18px;">java</a> <a href="/tags/linux/" style="font-size: 12px;">linux</a> <a href="/tags/redis/" style="font-size: 20px;">redis</a> <a href="/tags/spring/" style="font-size: 14px;">spring</a> <a href="/tags/sth/" style="font-size: 12px;">sth</a> <a href="/tags/%E6%8E%92%E9%9A%9C/" style="font-size: 10px;">排障</a> <a href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" style="font-size: 16px;">源码阅读</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/10/31/spring%E4%B9%8Bioc/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/10/31/%E5%BB%BA%E7%AB%99/">github + hexo建站[待补充]</a>
          </li>
        
          <li>
            <a href="/2023/10/17/springboot%E6%BA%90%E7%A0%81%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B3/">springboot源码之启动流程3</a>
          </li>
        
          <li>
            <a href="/2023/10/12/springboot%E6%BA%90%E7%A0%81%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B2/">springboot源码之启动流程2</a>
          </li>
        
          <li>
            <a href="/2023/10/10/springboot%E6%BA%90%E7%A0%81%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B1/">springboot源码之启动流程1</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 mqray<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>